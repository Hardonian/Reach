openapi: 3.1.0
info:
  title: Reach API
  description: |
    Deterministic execution fabric for AI systems. This API provides endpoints for
    managing runs, events, capsules, packs, and federation nodes.

    ## Versioning Policy
    - `apiVersion`: The API implementation version (e.g., "1.0.0")
    - `specVersion`: The OpenAPI spec version this document represents
    - Breaking changes will result in a new API version path (e.g., /v2/...)
    - Non-breaking additions are backward compatible within the same major version
  version: 1.0.0
  contact:
    name: Reach Team
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://127.0.0.1:8787
    description: Local development server (default)
  - url: http://localhost:8787
    description: Local development server (alternate)

paths:
  /health:
    get:
      operationId: getHealth
      summary: Health check
      description: Returns the health status of the Reach server
      tags:
        - System
      responses:
        "200":
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: ok
                version: "1.0.0"

  /version:
    get:
      operationId: getVersion
      summary: API version information
      description: Returns detailed version and compatibility information
      tags:
        - System
      responses:
        "200":
          description: Version information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VersionResponse"
              example:
                apiVersion: "1.0.0"
                specVersion: "1.0.0"
                compatibilityPolicy: "backward_compatible"
                supportedVersions:
                  - "1.0.0"

  /runs:
    post:
      operationId: createRun
      summary: Create a new run
      description: Start a new deterministic execution run
      tags:
        - Runs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateRunRequest"
            example:
              capabilities:
                - "tool.read"
                - "tool.write"
              plan_tier: "free"
      responses:
        "201":
          description: Run created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Run"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /runs/{id}:
    get:
      operationId: getRun
      summary: Get run details
      description: Retrieve details of a specific run by ID
      tags:
        - Runs
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: The run ID
      responses:
        "200":
          description: Run details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Run"
        "404":
          $ref: "#/components/responses/NotFound"

  /runs/{id}/events:
    get:
      operationId: getRunEvents
      summary: Get run events
      description: |
        Retrieve events for a specific run. Supports both standard JSON and
        Server-Sent Events (SSE) streaming via the Accept header.
      tags:
        - Runs
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: The run ID
        - name: after
          in: query
          schema:
            type: integer
            format: int64
          description: Event ID to start from (for pagination)
      responses:
        "200":
          description: List of events or SSE stream
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventsResponse"
            text/event-stream:
              schema:
                type: string
                format: binary

  /runs/{id}/replay:
    post:
      operationId: replayRun
      summary: Replay a run
      description: Replay a run from its event log for verification
      tags:
        - Runs
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: The run ID to replay
      responses:
        "200":
          description: Replay result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReplayResponse"

  /capsules:
    post:
      operationId: createCapsule
      summary: Create a capsule from a run
      description: Create a time capsule (immutable artifact) from a completed run
      tags:
        - Capsules
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCapsuleRequest"
            example:
              run_id: "run-abc123"
      responses:
        "201":
          description: Capsule created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Capsule"

  /capsules/verify:
    post:
      operationId: verifyCapsule
      summary: Verify a capsule
      description: Verify the integrity of a capsule file
      tags:
        - Capsules
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyCapsuleRequest"
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerificationResult"

  /federation/status:
    get:
      operationId: getFederationStatus
      summary: Get federation status
      description: Retrieve status of all federation nodes
      tags:
        - Federation
      responses:
        "200":
          description: Federation status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FederationStatus"

  /packs:
    get:
      operationId: listPacks
      summary: List/search packs
      description: Search and list available execution packs in the registry
      tags:
        - Packs
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: Search query string
      responses:
        "200":
          description: List of packs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PacksResponse"

  /packs/install:
    post:
      operationId: installPack
      summary: Install a pack
      description: Install a pack from the registry
      tags:
        - Packs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InstallPackRequest"
      responses:
        "200":
          description: Pack installed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InstallPackResponse"

  /packs/verify:
    post:
      operationId: verifyPack
      summary: Verify a pack
      description: Verify pack signature and compatibility
      tags:
        - Packs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyPackRequest"
      responses:
        "200":
          description: Verification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerificationResult"

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - version
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        version:
          type: string

    VersionResponse:
      type: object
      required:
        - apiVersion
        - specVersion
      properties:
        apiVersion:
          type: string
          description: The API implementation version
        specVersion:
          type: string
          description: The OpenAPI spec version
        compatibilityPolicy:
          type: string
          enum: [backward_compatible, breaking_changes]
        supportedVersions:
          type: array
          items:
            type: string

    CreateRunRequest:
      type: object
      properties:
        capabilities:
          type: array
          items:
            type: string
          description: List of capabilities required for this run
        plan_tier:
          type: string
          enum: [free, pro, enterprise]
          default: free

    Run:
      type: object
      required:
        - id
        - status
        - created_at
      properties:
        id:
          type: string
          description: Unique run identifier
        status:
          type: string
          enum: [pending, running, completed, failed, cancelled]
        tier:
          type: string
          enum: [free, pro, enterprise]
        capabilities:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    EventsResponse:
      type: object
      required:
        - events
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/Event"

    Event:
      type: object
      required:
        - id
        - type
        - created_at
      properties:
        id:
          type: integer
          format: int64
        type:
          type: string
        payload:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time

    ReplayResponse:
      type: object
      required:
        - run_id
        - replay_verified
        - steps
      properties:
        run_id:
          type: string
        replay_verified:
          type: boolean
        steps:
          type: integer
        policy:
          type: object
          additionalProperties: true

    CreateCapsuleRequest:
      type: object
      required:
        - run_id
      properties:
        run_id:
          type: string
          description: The run ID to create a capsule from

    Capsule:
      type: object
      required:
        - manifest
        - event_log
      properties:
        manifest:
          $ref: "#/components/schemas/CapsuleManifest"
        event_log:
          type: array
          items:
            type: object

    CapsuleManifest:
      type: object
      required:
        - spec_version
        - run_id
        - run_fingerprint
        - created_at
      properties:
        spec_version:
          type: string
        run_id:
          type: string
        run_fingerprint:
          type: string
          description: Deterministic hash of the event log
        registry_snapshot_hash:
          type: string
        pack:
          type: object
        policy:
          type: object
        federation_path:
          type: array
          items:
            type: string
        trust_scores:
          type: object
          additionalProperties:
            type: number
        audit_root:
          type: string
        environment:
          type: object
          additionalProperties:
            type: string
        created_at:
          type: string
          format: date-time

    VerifyCapsuleRequest:
      type: object
      required:
        - path
      properties:
        path:
          type: string
          description: Path to the capsule file

    FederationStatus:
      type: object
      required:
        - nodes
      properties:
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/FederationNode"

    FederationNode:
      type: object
      required:
        - node_id
        - status
      properties:
        node_id:
          type: string
        status:
          type: string
          enum: [active, inactive, quarantined]
        capabilities:
          type: array
          items:
            type: string
        latency_ms:
          type: integer
        load_score:
          type: integer
        trust_score:
          type: number
        quarantined:
          type: boolean

    PacksResponse:
      type: object
      required:
        - results
      properties:
        results:
          type: array
          items:
            $ref: "#/components/schemas/Pack"

    Pack:
      type: object
      required:
        - name
        - repo
        - spec_version
      properties:
        name:
          type: string
        repo:
          type: string
        spec_version:
          type: string
        signature:
          type: string
        reproducibility:
          type: string
          enum: [A, B, C, D, F]
        verified:
          type: boolean

    InstallPackRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Name of the pack to install

    InstallPackResponse:
      type: object
      required:
        - installed
        - path
      properties:
        installed:
          type: string
        path:
          type: string
        verified_badge:
          type: boolean

    VerifyPackRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string

    VerificationResult:
      type: object
      required:
        - verified
      properties:
        verified:
          type: boolean
        name:
          type: string
        signature_valid:
          type: boolean
        spec_compatible:
          type: boolean
        run_id:
          type: string
        run_fingerprint:
          type: string
        recomputed_fingerprint:
          type: string
        audit_root:
          type: string

    ReachError:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
        details:
          type: object
          additionalProperties: true
        remediation:
          type: string
          description: Suggested action to resolve the error

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ReachError"
          example:
            error: "Invalid request body"
            code: "INVALID_REQUEST"
            remediation: "Check the request body matches the expected schema"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ReachError"
          example:
            error: "Run not found"
            code: "RUN_NOT_FOUND"
            remediation: "Verify the run ID exists"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ReachError"
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"
            remediation: "Please try again later or contact support"
