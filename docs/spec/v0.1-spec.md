# Reach Formal Spec v0.1

## Core loop
Input -> canonicalization (`determinism.CanonicalJSON`) -> SHA-256 hashing -> transcript append -> verify (`HashEventLog`) -> replay check.

## Determinism contract
- Guarantees: identical canonical inputs produce identical hashes.
- Non-guarantees: wall-clock/network/process scheduler.
- Forbidden nondeterminism: unsorted map hashing, random IDs in fingerprint paths.
- Versioning: hash/schema/capsule/protocol constants are locked in `internal/trust/versions.go`.

## Capsule format
Required: `manifest.run_id`, `manifest.run_fingerprint`, `event_log`.
Hash rule: replay hash = `HashEventLog(event_log, run_id)`.
Compatibility: schema/hash version lock required for breaking changes.

## Pack manifest
Must declare deterministic boundary and metadata; compatibility ranges must be explicit and versioned.

## Content-addressable cache (CAC)
- Addressed by SHA-256 of exact bytes.
- Immutable object store by explicit type.
- API: `put/get/has/verify/status/gc`.
- GC only removes invalid/non-hash entries; valid objects immutable.

## Remote replay validation protocol
- Versioned protocol (`protocol_version=1`).
- Endpoints: `/health`, `/public-key`, `/validate`.
- Validate request includes capsule payload.
- Response: request hash, capsule hash, verify/replay booleans, tool versions, Ed25519 signature.

## Deterministic LLM memory hashing bridge
- Canonicalizes memory items (`memory_id`, `type`, role/content/tool/attachments/metadata).
- Produces hash-only anchor; no model invocation.
- Optional run integration via memory anchor hashes; verification checks anchor hash integrity when present.
