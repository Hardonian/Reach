#!/usr/bin/env bash
set -euo pipefail

cmd="${1:-}"
case "$cmd" in
  version)
    shift
    (cd services/runner && go run ./cmd/reachctl version "$@")
    ;;
  doctor)
    shift
    (cd tools/doctor && go run . "$@")
    ;;
  audit)
    shift
    (cd tools/reach-audit && go run . "$@")
    ;;
  eval)
    shift
    (cd tools/reach-eval && go run . "$@")
    ;;
  release-check)
    shift
    ./tools/release-check.sh "$@"
    ;;
  serve)
    shift
    (cd services/runner && go run ./cmd/reach-serve "$@")
    ;;
  federation)
    shift
    (cd services/runner && go run ./cmd/reachctl federation "$@")
    ;;
  support)
    shift
    (cd services/runner && go run ./cmd/reachctl support "$@")
    ;;
  arcade)
    shift
    (cd services/runner && go run ./cmd/reachctl arcade "$@")
    ;;
  capsule)
    shift
    (cd services/runner && go run ./cmd/reachctl capsule "$@")
    ;;
  proof)
    shift
    (cd services/runner && go run ./cmd/reachctl proof "$@")
    ;;
  graph)
    shift
    (cd services/runner && go run ./cmd/reachctl graph "$@")
    ;;
  packs)
    shift
    (cd services/runner && go run ./cmd/reachctl packs "$@")
    ;;
  init)
    shift
    (cd services/runner && go run ./cmd/reachctl init "$@")
    ;;
  config)
    shift
    (cd services/runner && go run ./cmd/reachctl config "$@")
    ;;
  explain)
    shift
    (cd services/runner && go run ./cmd/reachctl explain "$@")
    ;;
  operator)
    shift
    (cd services/runner && go run ./cmd/reachctl operator "$@")
    ;;
  pack)
    shift
    (cd services/runner && go run ./cmd/reachctl pack "$@")
    ;;
  wizard)
    shift
    (cd services/runner && go run ./cmd/reachctl wizard "$@")
    ;;
  run)
    shift
    (cd services/runner && go run ./cmd/reachctl run "$@")
    ;;
  share)
    shift
    (cd services/runner && go run ./cmd/reachctl share "$@")
    ;;
  delegate)
    shift
    (cd services/runner && go run ./cmd/reachctl delegate "$@")
    ;;
  verify-proof)
    shift
    (cd services/runner && go run ./cmd/reachctl verify-proof "$@")
    ;;
  gate)
    shift
    (cd services/runner && go run ./cmd/reachctl gate "$@")
    ;;
  cost)
    shift
    # Ensure dependencies are installed for the tool
    (cd tools/economics && npm install --silent && npm start --silent -- report "$@")
    ;;
  metrics)
    shift
    case "${1:-}" in
      gtm) shift; (cd tools/economics && npm install --silent && npm start --silent -- metrics "$@") ;;
      *) (cd tools/economics && npm install --silent && npm start --silent -- metrics "$@") ;;
    esac
    ;;
  state)
    shift
    (cd services/runner && go run ./cmd/reachctl state "$@")
    ;;
  verify-security)
    shift
    (cd services/runner && go run ./cmd/reachctl verify-security "$@")
    ;;
  simulate)
    shift
    (cd services/runner && go run ./cmd/reachctl simulate "$@")
    ;;
  help|--help|-h)
    echo "Reach - Deterministic Execution Fabric"
    echo ""
    echo "Commands:"
    echo "  doctor           - System health check"
    echo "  eval             - Evaluate runs and regressions"
    echo "  wizard           - Guided run wizard (mobile-friendly)"
    echo "  run <pack>       - Quick run a pack"
    echo "  share            - Share runs via QR/text"
    echo "  operator         - View operator dashboard"
    echo "  audit            - Export/verify signed audit logs"
    echo "  capsule          - Create/verify capsules"
    echo "  proof            - Verify execution proofs"
    echo "  packs            - Search/install packs"
    echo "  cost             - View cost analysis and unit economics"
    echo "  metrics          - View GTM and usage metrics"
    echo "  gate             - Manage repository release gates"
    echo "  state            - Inspect semantic states and transitions"
    echo "  verify-security  - Verify local integrity posture"
    echo ""
    echo "For mobile/Termux: Install with scripts/install-termux.sh"
    ;;
  *)
    echo "usage: reach version|doctor|audit|eval|release-check|serve|federation|support|arcade|capsule|proof|graph|packs|init|explain|operator|pack|wizard|run|share|delegate|verify-proof|cost|metrics|gate|state|verify-security|simulate" >&2
    echo "       reach help for more info" >&2
    exit 1
    ;;

esac
