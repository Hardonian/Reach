name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Build matrix for all supported platforms
  build-matrix:
    strategy:
      matrix:
        include:
          # Linux AMD64
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            binary: reachctl-linux-amd64
          # Linux ARM64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            binary: reachctl-linux-arm64
          # macOS AMD64
          - os: macos-latest
            goos: darwin
            goarch: amd64
            binary: reachctl-darwin-amd64
          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            goos: darwin
            goarch: arm64
            binary: reachctl-darwin-arm64
          # Windows AMD64
          - os: windows-latest
            goos: windows
            goarch: amd64
            binary: reachctl-windows-amd64.exe

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.7"
          cache: true

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT
          fi

      - name: Build binary
        shell: bash
        run: |
          # Build with version info and stripped symbols
          LDFLAGS="-s -w -X main.version=${{ steps.version.outputs.VERSION }} -X main.commit=${GITHUB_SHA::8} -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
            go build -ldflags "$LDFLAGS" \
            -o dist/${{ matrix.binary }} \
            ./services/runner/cmd/reachctl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: dist/${{ matrix.binary }}
          retention-days: 7

  # Build wrapper script and additional artifacts
  build-extras:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare extras
        run: |
          mkdir -p dist
          cp reach dist/reach
          cp scripts/release/install.sh dist/install.sh
          cp scripts/release/install.ps1 dist/install.ps1
          cp README.md dist/README.md
          cp LICENSE dist/LICENSE
          cp VERSION dist/VERSION
          chmod +x dist/reach dist/install.sh

      - name: Upload extras
        uses: actions/upload-artifact@v4
        with:
          name: extras
          path: dist/*
          retention-days: 7

  # Test all binaries work
  test-binaries:
    needs: [build-matrix, build-extras]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: reachctl-linux-amd64
          - os: macos-latest
            binary: reachctl-darwin-amd64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: dist
      - uses: actions/download-artifact@v4
        with:
          name: extras
          path: dist

      - name: Test binary
        run: |
          chmod +x dist/${{ matrix.binary }}
          ./dist/${{ matrix.binary }} version

      - name: Simulate install script
        shell: bash
        run: |
          set -euo pipefail
          if command -v sha256sum >/dev/null 2>&1; then
            (cd dist && sha256sum "${{ matrix.binary }}" reach > SHA256SUMS)
          else
            (cd dist && shasum -a 256 "${{ matrix.binary }}" reach | awk '{print $1"  "$2}' > SHA256SUMS)
          fi
          INSTALL_DIR="${RUNNER_TEMP}/reach-bin"
          VERSION="$(cat VERSION)"
          REACH_VERSION="${VERSION}" REACH_RELEASE_DIR="${PWD}/dist" INSTALL_DIR="${INSTALL_DIR}" bash dist/install.sh
          "${INSTALL_DIR}/reach" version
          set +e
          "${INSTALL_DIR}/reach" doctor
          doctor_exit=$?
          set -e
          if [ "$doctor_exit" -ne 0 ] && [ "$doctor_exit" -ne 1 ]; then
            echo "doctor command failed unexpectedly with code ${doctor_exit}" >&2
            exit "$doctor_exit"
          fi

  test-windows-installer:
    needs: [build-matrix, build-extras]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: reachctl-windows-amd64.exe
          path: dist
      - uses: actions/download-artifact@v4
        with:
          name: extras
          path: dist
      - name: Simulate PowerShell installer
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $dist = Resolve-Path "dist"
          $hashExe = (Get-FileHash -Path (Join-Path $dist "reachctl-windows-amd64.exe") -Algorithm SHA256).Hash.ToLowerInvariant()
          $hashReach = (Get-FileHash -Path (Join-Path $dist "reach") -Algorithm SHA256).Hash.ToLowerInvariant()
          @(
            "$hashExe  reachctl-windows-amd64.exe"
            "$hashReach  reach"
          ) | Set-Content -Path (Join-Path $dist "SHA256SUMS")

          $version = (Get-Content "VERSION" -Raw).Trim()
          $installDir = Join-Path $env:RUNNER_TEMP "reach-bin"
          & (Join-Path $dist "install.ps1") -Version $version -InstallDir $installDir -ReleaseDir $dist
          & (Join-Path $installDir "reachctl.exe") version
          & (Join-Path $installDir "reachctl.exe") doctor
          if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne 1) {
            throw "doctor command failed unexpectedly with exit code $LASTEXITCODE"
          }

  # Create GitHub Release and publish artifacts
  publish:
    runs-on: ubuntu-latest
    needs: [build-matrix, build-extras, test-binaries, test-windows-installer]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "reachctl-*"
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: extras
          path: artifacts

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate release checksums
        run: |
          cd artifacts
          LC_ALL=C find . -maxdepth 1 -type f -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS

      - name: Generate artifact manifest
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          artifacts = Path("artifacts")
          checksums = {}
          for line in (artifacts / "SHA256SUMS").read_text(encoding="utf-8").splitlines():
            if not line.strip():
              continue
            h, name = line.split(None, 1)
            checksums[name.strip()] = h.strip()

          manifest = {
            "schema": "reach.release.manifest.v1",
            "tag": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "artifacts": [
              {"name": name, "sha256": checksums[name]} for name in sorted(checksums.keys())
            ],
          }
          (artifacts / "artifact-manifest.json").write_text(json.dumps(manifest, indent=2) + "\n", encoding="utf-8")
          PY

      - name: Render release notes from changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          node scripts/release/render-release-notes.mjs --version "$VERSION" --output artifacts/RELEASE_NOTES.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          body_path: artifacts/RELEASE_NOTES.md
          generate_release_notes: false
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}

  # Verify release
  verify-release:
    runs-on: ubuntu-latest
    needs: publish
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Verify release assets
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "Verifying release v${VERSION}..."

          # Check all expected assets exist
          ASSETS=(
            "reachctl-linux-amd64"
            "reachctl-linux-arm64"
            "reachctl-darwin-amd64"
            "reachctl-darwin-arm64"
            "reachctl-windows-amd64.exe"
            "reach"
            "install.sh"
            "install.ps1"
            "SHA256SUMS"
            "artifact-manifest.json"
            "RELEASE_NOTES.md"
          )

          for asset in "${ASSETS[@]}"; do
            URL="https://github.com/reach/reach/releases/download/v${VERSION}/${asset}"
            echo "Checking: $URL"
            STATUS_CODE="$(curl --retry 5 --retry-delay 2 --retry-all-errors -sIL -o /dev/null -w "%{http_code}" "$URL")"
            if [[ "$STATUS_CODE" != "200" ]]; then
              echo "Missing: $asset (status $STATUS_CODE)"
              exit 1
            fi
          done

          echo "All release assets verified!"
